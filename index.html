<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‚«ãƒ¡ãƒ©ç›£è¦–ãƒ“ãƒ¥ãƒ¼ã‚¢ (ãƒ—ãƒ­ã‚­ã‚·æ¥ç¶šå¯¾å¿œ)</title>
    <!-- Tailwind CSS ã‚’ãƒ­ãƒ¼ãƒ‰ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .image-container {
            width: 100%;
            height: 180px; /* ç”»åƒã®ç¸¦æ¨ªæ¯”ã‚’è€ƒæ…®ã—ãŸå›ºå®šé«˜ã• */
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: #f3f4f6;
            border-radius: 8px;
            overflow: hidden;
        }
        .camera-image {
            width: 100%;
            height: 100%;
            object-fit: contain; /* ç”»åƒå…¨ä½“ã‚’è¡¨ç¤ºã—ã€æ ã«åˆã‚ã›ã‚‹ */
        }
    </style>
</head>
<body class="bg-gray-100 font-sans">
    <div class="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8">
        <h1 class="text-3xl font-extrabold text-gray-800 mb-6">ã‚«ãƒ¡ãƒ©ãƒ©ã‚¤ãƒ–ãƒ“ãƒ¥ãƒ¼ã‚¢</h1>

        <!-- CSV ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆèª¬æ˜ã‚¨ãƒªã‚¢ -->
        <div class="bg-white p-4 border border-gray-200 rounded-xl shadow-md mb-6">
            <p class="text-sm font-semibold text-gray-700 mb-2">CSVãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ: **URL**,"**ã‚«ãƒ¡ãƒ©å**","**ID**","**PASS**"</p>
            <p class="text-xs text-gray-500">ä¾‹: http://192.168.1.1/cgi/Entrance.user,pass123,Entrance,user,pass123</p>
        </div>

        <!-- ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒ‘ãƒãƒ« -->
        <div class="flex flex-wrap items-center space-y-4 md:space-y-0 md:space-x-4 mb-8">
            <input type="file" id="csvFile" accept=".csv" class="hidden" onchange="displayFileName(this)">
            
            <button onclick="document.getElementById('csvFile').click()" class="px-4 py-2 bg-gray-500 text-white font-semibold rounded-lg hover:bg-gray-600 transition duration-150 shadow-md">
                ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ
                <span id="fileNameDisplay" class="ml-2 text-sm text-gray-200">æœªé¸æŠ</span>
            </button>
            
            <button onclick="handleCsvUpload()" class="px-6 py-2 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700 transition duration-150 shadow-md">
                CSVã‚’èª­ã¿è¾¼ã‚€
            </button>
            
            <span id="cameraCount" class="text-lg font-bold text-orange-600 ml-4">ã‚«ãƒ¡ãƒ© 0å°ã‚’ç™»éŒ²ã—ã¾ã—ãŸ</span>

            <div class="flex space-x-2 ml-auto">
                <button id="refreshButton" onclick="fetchImages()" class="px-6 py-2 bg-indigo-600 text-white font-bold rounded-lg hover:bg-indigo-700 transition duration-150 shadow-md">
                    å…¨ã¦ã®ç”»åƒã‚’å†å–å¾—
                </button>
                <button onclick="alert('PDFä¿å­˜æ©Ÿèƒ½ã¯æœªå®Ÿè£…ã§ã™ã€‚')" class="px-6 py-2 bg-red-600 text-white font-bold rounded-lg hover:bg-red-700 transition duration-150 shadow-md">
                    PDFã¨ã—ã¦ä¿å­˜
                </button>
            </div>
        </div>

        <!-- å–å¾—çµæœã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ -->
        <div class="mb-6">
            <span id="fetchStatus" class="text-lg font-semibold text-gray-700">å–å¾—å®Œäº†ã€‚æˆåŠŸ: 0ä»¶ / å…¨ä½“: 0ä»¶</span>
        </div>

        <!-- ã‚«ãƒ¡ãƒ©ã‚°ãƒªãƒƒãƒ‰ -->
        <div id="cameraGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
            <!-- ã‚«ãƒ¡ãƒ©ã‚«ãƒ¼ãƒ‰ãŒã“ã“ã«å‹•çš„ã«æŒ¿å…¥ã•ã‚Œã¾ã™ -->
        </div>

    </div>

    <script>
        let cameras = [];
        const PROXY_BASE_URL = 'https://toracame-proxy.onrender.com/proxy'; 

        // ==============================================
        // CSV å‡¦ç†ãƒ­ã‚¸ãƒƒã‚¯
        // ==============================================

        function displayFileName(input) {
            const display = document.getElementById('fileNameDisplay');
            display.textContent = input.files[0] ? input.files[0].name : 'æœªé¸æŠ';
        }

        function parseCSV(text) {
            const lines = text.trim().split('\n');
            if (lines.length < 2) return [];

            const result = [];
            // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã€ãƒ‡ãƒ¼ã‚¿è¡Œã‹ã‚‰å‡¦ç†
            for (let i = 1; i < lines.length; i++) {
                const parts = lines[i].split(',');
                // CSVãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ: URL,ã‚«ãƒ¡ãƒ©å,ID,PASS
                if (parts.length >= 4) {
                    result.push({
                        url: parts[0].trim(),
                        name: parts[1].trim(),
                        id: parts[2].trim(),
                        password: parts[3].trim(),
                    });
                }
            }
            return result;
        }

        function handleCsvUpload() {
            const fileInput = document.getElementById('csvFile');
            const file = fileInput.files[0];

            if (!file) {
                alert('CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
                return;
            }

            const reader = new FileReader();
            reader.onload = (e) => {
                const csvText = e.target.result;
                cameras = parseCSV(csvText);
                document.getElementById('cameraCount').textContent = `ã‚«ãƒ¡ãƒ© ${cameras.length}å°ã‚’ç™»éŒ²ã—ã¾ã—ãŸ`;
                renderCameras();
            };
            // æ—¥æœ¬èªã®CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’æƒ³å®šã—ã€Shift_JISã§èª­ã¿è¾¼ã¿
            reader.readAsText(file, 'Shift_JIS'); 
        }

        // ==============================================
        // UI ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ãƒ­ã‚¸ãƒƒã‚¯
        // ==============================================

        function renderCameras() {
            const grid = document.getElementById('cameraGrid');
            grid.innerHTML = ''; // ã‚«ãƒ¡ãƒ©ã‚°ãƒªãƒƒãƒ‰ã‚’ã‚¯ãƒªã‚¢

            if (cameras.length === 0) {
                grid.innerHTML = '<p class="text-gray-500 col-span-4">CSVã‚’èª­ã¿è¾¼ã‚“ã§ã‚«ãƒ¡ãƒ©ã‚’ç™»éŒ²ã—ã¦ãã ã•ã„ã€‚</p>';
                document.getElementById('fetchStatus').textContent = 'å–å¾—å®Œäº†ã€‚æˆåŠŸ: 0ä»¶ / å…¨ä½“: 0ä»¶';
                return;
            }

            cameras.forEach((camera, index) => {
                const cameraCard = document.createElement('div');
                cameraCard.className = 'bg-white shadow-lg rounded-xl p-4 transition duration-200 hover:shadow-xl';
                cameraCard.innerHTML = `
                    <h3 class="text-lg font-semibold text-gray-800 mb-2">${index + 1}. ${camera.name}</h3>
                    <div class="image-container">
                        <img id="image-${index}" class="camera-image" src="https://placehold.co/100x100/eeeeee/000000?text=æœªå–å¾—" alt="${camera.name}ç”»åƒ">
                    </div>
                    <p id="status-${index}" class="mt-3 text-center font-bold text-gray-500">æœªå–å¾—</p>
                `;
                grid.appendChild(cameraCard);
            });

            // ãƒ­ãƒ¼ãƒ‰å¾Œã€ã™ãã«ç”»åƒå–å¾—ã‚’é–‹å§‹
            fetchImages();
        }

        // ==============================================
        // æœ€çµ‚èª¿æ•´ç‰ˆ: ç”»åƒå–å¾—ã¨ãƒªãƒˆãƒ©ã‚¤ãƒ­ã‚¸ãƒƒã‚¯ (ç”»åƒãƒ‡ã‚³ãƒ¼ãƒ‰å¤±æ•—ç›£è¦–æ©Ÿèƒ½è¿½åŠ )
        // ==============================================
        async function fetchSingleImage(camera, index) {
            const statusElement = document.getElementById(`status-${index}`);
            const imageElement = document.getElementById(`image-${index}`);
            
            // UIã‚’ãƒªã‚»ãƒƒãƒˆ
            statusElement.textContent = 'å–å¾—ä¸­...';
            statusElement.className = 'mt-3 text-center font-bold text-gray-500';
            imageElement.src = 'https://placehold.co/100x100/eeeeee/000000?text=Loading';

            const MAX_RETRIES = 5; // ãƒªãƒˆãƒ©ã‚¤å›æ•°ã‚’å¢—ã‚„ã—ã¾ã™
            const RETRY_DELAY_MS = 1500; 
            const MIN_IMAGE_SIZE = 500; 
            let lastError = null;

            for (let attempt = 1; attempt <= MAX_RETRIES; attempt++) {
                try {
                    // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒã‚¹ã‚¿ãƒ¼ã¨ãƒ—ãƒ­ã‚­ã‚·URLã®æ§‹ç¯‰
                    const cacheBuster = `&_ts=${Date.now()}`;
                    const proxyUrl = `${PROXY_BASE_URL}?url=${encodeURIComponent(camera.url)}&id=${encodeURIComponent(camera.id)}&password=${encodeURIComponent(camera.password)}${cacheBuster}`;
                    
                    const response = await fetch(proxyUrl);

                    if (response.ok) {
                        const buffer = await response.arrayBuffer();
                        const blob = new Blob([buffer], { type: 'image/jpeg' });
                        
                        // ãƒ‡ãƒ¼ã‚¿ã®ã‚µã‚¤ã‚ºãƒã‚§ãƒƒã‚¯
                        if (blob.size < MIN_IMAGE_SIZE) {
                            lastError = `ç”»åƒãƒ‡ãƒ¼ã‚¿ãŒå°ã•ã™ãã¾ã™ (${blob.size} bytes)ã€‚`;
                            console.warn(`ã‚«ãƒ¡ãƒ© ${index + 1}: ${lastError} ãƒªãƒˆãƒ©ã‚¤å®Ÿè¡Œ`);
                            
                            if (attempt < MAX_RETRIES) {
                                statusElement.textContent = `ä¸å®Œå…¨ãƒ‡ãƒ¼ã‚¿ã€‚ãƒªãƒˆãƒ©ã‚¤ä¸­ (${attempt}/${MAX_RETRIES})...`;
                                await new Promise(resolve => setTimeout(resolve, RETRY_DELAY_MS));
                                continue; 
                            }
                        }

                        // æˆåŠŸã—ãŸå ´åˆã€Blob URLã‚’ä½œæˆã—ã¦è¡¨ç¤º
                        const imageUrl = URL.createObjectURL(blob);
                        
                        // ğŸ’¡ æœ€çµ‚èª¿æ•´ç‚¹: ç”»åƒã®ãƒ­ãƒ¼ãƒ‰æˆåŠŸ/å¤±æ•—ã‚’ç›£è¦–ã™ã‚‹
                        const imageLoadPromise = new Promise((resolve, reject) => {
                            // æˆåŠŸã—ãŸå ´åˆ
                            imageElement.onload = () => resolve(true);
                            // å¤±æ•—ã—ãŸå ´åˆ (ãƒ‡ãƒ¼ã‚¿ãŒä¸æ­£ã§ãƒ–ãƒ©ã‚¦ã‚¶ãŒãƒ‡ã‚³ãƒ¼ãƒ‰ã§ããªã‹ã£ãŸå ´åˆ)
                            imageElement.onerror = () => reject(new Error('ç”»åƒãƒ‡ã‚³ãƒ¼ãƒ‰å¤±æ•— (ä¸æ­£ãªãƒ‡ãƒ¼ã‚¿æ§‹é€ )'));
                            
                            // ç”»åƒã‚½ãƒ¼ã‚¹ã‚’è¨­å®šã—ã€ãƒ­ãƒ¼ãƒ‰ã‚’é–‹å§‹
                            imageElement.src = imageUrl;
                        });

                        await imageLoadPromise; // ãƒ­ãƒ¼ãƒ‰å®Œäº†ã‚’å¾…ã¤

                        // ãƒ­ãƒ¼ãƒ‰æˆåŠŸå¾Œã®å‡¦ç†
                        statusElement.textContent = 'OK';
                        statusElement.className = 'mt-3 text-center font-bold text-green-600';
                        console.log(`ã‚«ãƒ¡ãƒ© ${index + 1}: å–å¾—æˆåŠŸ (è©¦è¡Œ ${attempt}å›ç›®), ã‚µã‚¤ã‚º: ${blob.size} bytes`);
                        return { success: true, camera: camera.name };
                        
                    } else {
                        // ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼ (401, 500ãªã©) ã®å‡¦ç†
                        const errorText = await response.text();
                        lastError = `ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼: ${response.status} ${response.statusText} (${errorText.substring(0, 50)}...)`;
                        console.error(`ã‚«ãƒ¡ãƒ© ${index + 1}: å–å¾—å¤±æ•— (è©¦è¡Œ ${attempt}å›ç›®): ${lastError}`);
                        
                        if (attempt < MAX_RETRIES) {
                            statusElement.textContent = `ãƒªãƒˆãƒ©ã‚¤ä¸­ (${attempt}/${MAX_RETRIES})...`;
                            await new Promise(resolve => setTimeout(resolve, RETRY_DELAY_MS));
                        }
                    }
                } catch (error) {
                    // ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ã€ã¾ãŸã¯ç”»åƒãƒ‡ã‚³ãƒ¼ãƒ‰å¤±æ•—ã‚¨ãƒ©ãƒ¼
                    lastError = `å‡¦ç†å¤±æ•—: ${error.message}`;
                    console.error(`ã‚«ãƒ¡ãƒ© ${index + 1}: å‡¦ç†å¤±æ•— (è©¦è¡Œ ${attempt}å›ç›®):`, error);

                    if (attempt < MAX_RETRIES) {
                        statusElement.textContent = `ãƒªãƒˆãƒ©ã‚¤ä¸­ (${attempt}/${MAX_RETRIES})...`;
                        await new Promise(resolve => setTimeout(resolve, RETRY_DELAY_MS));
                    }
                }
            }

            // å…¨ã¦ã®ãƒªãƒˆãƒ©ã‚¤ãŒå¤±æ•—ã—ãŸå ´åˆ
            statusElement.textContent = `ã‚¨ãƒ©ãƒ¼: ${lastError}`;
            statusElement.className = 'mt-3 text-center font-bold text-red-600';
            imageElement.src = 'https://placehold.co/100x100/ffbbbb/800000?text=ã‚¨ãƒ©ãƒ¼';
            console.error(`ã‚«ãƒ¡ãƒ© ${index + 1}: æœ€çµ‚å–å¾—å¤±æ•—`);
            return { success: false, camera: camera.name };
        }

        async function fetchImages() {
            if (cameras.length === 0) {
                alert('ã‚«ãƒ¡ãƒ©ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚CSVã‚’èª­ã¿è¾¼ã‚“ã§ãã ã•ã„ã€‚');
                return;
            }

            const refreshButton = document.getElementById('refreshButton');
            refreshButton.disabled = true;
            refreshButton.textContent = 'å–å¾—å‡¦ç†ä¸­...';

            const promises = cameras.map((camera, index) => fetchSingleImage(camera, index));
            const results = await Promise.allSettled(promises);

            let successCount = 0;
            results.forEach(result => {
                if (result.status === 'fulfilled' && result.value.success) {
                    successCount++;
                }
            });

            document.getElementById('fetchStatus').textContent = `å–å¾—å®Œäº†ã€‚æˆåŠŸ: ${successCount}ä»¶ / å…¨ä½“: ${cameras.length}ä»¶`;

            refreshButton.disabled = false;
            refreshButton.textContent = 'å…¨ã¦ã®ç”»åƒã‚’å†å–å¾—';
        }

        // ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰æ™‚ã®åˆæœŸåŒ–
        window.onload = () => {
             // ç‰¹ã«åˆæœŸè¨­å®šã¯ãªã—ã€‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒCSVã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ã®ã‚’å¾…ã¤
        };
    </script>
</body>
</html>
